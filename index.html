<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Nexus Chat â€¢ Firebase</title>
  <style>
    :root{--bg:#0b0b0e;--panel:#121216;--gold:#c7a24b;--muted:#9aa0a6}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Arial,sans-serif;background:var(--bg);color:#f2f2f2}
    header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #222;background:var(--panel)}
    h1{font-size:16px;margin:0}
    #user{display:flex;gap:8px;align-items:center}
    #user img{width:28px;height:28px;border-radius:50%;display:none}
    main{height:calc(100vh - 130px);overflow:auto;padding:16px;display:flex;flex-direction:column;gap:10px}
    .msg{max-width:75%;padding:10px 12px;border-radius:10px;background:#1c1c21;position:relative}
    .me{align-self:flex-end;background:#212129}
    .meta{font-size:12px;opacity:.8;margin-bottom:4px;display:flex;gap:8px;align-items:center;justify-content:space-between}
    .meta-left{display:flex;gap:8px;align-items:center}
    .edited{font-size:11px;color:var(--muted)}
    .actions{display:flex;gap:4px}
    .btn-icon{background:transparent;border:0;color:#bbb;cursor:pointer;padding:2px 6px;border-radius:6px}
    .btn-icon:hover{color:#fff;background:#2a2a2f}
    form{display:flex;gap:8px;padding:12px;border-top:1px solid #222;background:var(--panel)}
    input{flex:1;padding:10px;border:1px solid #333;background:#141416;color:#fff;border-radius:8px}
    button{padding:10px 14px;border:0;border-radius:8px;background:var(--gold);color:#000;font-weight:600;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
  </style>
</head>
<body>
  <header>
    <h1>ðŸ’¬ Nexus Chat</h1>
    <div id="user">
      <img id="avatar" alt="">
      <span id="username"></span>
      <button id="signInBtn">Entrar con Google</button>
      <button id="signOutBtn" style="display:none">Salir</button>
    </div>
  </header>

  <main id="messages" aria-live="polite"></main>

  <form id="msgForm" autocomplete="off">
    <input id="msgInput" type="text" placeholder="Escribe un mensaje...">
    <button id="sendBtn" type="submit" disabled>Enviar</button>
  </form>

  <!-- Firebase v11 (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp,
      onSnapshot, query, orderBy, limit, doc, updateDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    // -------- TU CONFIG --------
    const firebaseConfig = {
      apiKey: "AIzaSyCp23981tPx3DsXvPyK4ZeAfkFPb3pL6pU",
      authDomain: "nexus-chat-7e32b.firebaseapp.com",
      projectId: "nexus-chat-7e32b",
      storageBucket: "nexus-chat-7e32b.appspot.com",
      messagingSenderId: "780849892655",
      appId: "1:780849892655:web:b329ad45dffb7931f3a5da"
    };
    // ---------------------------

    // Init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const db = getFirestore(app);

    // UI refs
    const signInBtn = document.getElementById('signInBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const avatar = document.getElementById('avatar');
    const username = document.getElementById('username');
    const messagesEl = document.getElementById('messages');
    const form = document.getElementById('msgForm');
    const input = document.getElementById('msgInput');
    const sendBtn = document.getElementById('sendBtn');

    // Auth handlers
    signInBtn.onclick = () => signInWithPopup(auth, provider);
    signOutBtn.onclick = () => signOut(auth);

    onAuthStateChanged(auth, user => {
      if (user) {
        signInBtn.style.display = 'none';
        signOutBtn.style.display = 'inline-block';
        avatar.src = user.photoURL || '';
        avatar.style.display = user.photoURL ? 'inline-block' : 'none';
        username.textContent = user.displayName || user.email;
        sendBtn.disabled = false;
      } else {
        signInBtn.style.display = 'inline-block';
        signOutBtn.style.display = 'none';
        avatar.style.display = 'none';
        username.textContent = '';
        sendBtn.disabled = true;
      }
    });

    // Firestore: colecciÃ³n de mensajes en una sala global
    const msgsRef = collection(db, "rooms", "global", "messages");
    const q = query(msgsRef, orderBy("createdAt", "asc"), limit(500));

    // Render en tiempo real con acciones de editar/borrar del dueÃ±o
    onSnapshot(q, snap => {
      messagesEl.innerHTML = "";
      const me = auth.currentUser?.uid;
      snap.forEach(docSnap => {
        const m = docSnap.data();
        const id = docSnap.id;

        const div = document.createElement('div');
        div.className = "msg" + (m.uid === me ? " me" : "");

        const meta = document.createElement('div');
        meta.className = 'meta';

        const left = document.createElement('div');
        left.className = 'meta-left';
        const nameSpan = document.createElement('span');
        nameSpan.textContent = m.name || "AnÃ³nimo";
        left.appendChild(nameSpan);

        if (m.editedAt) {
          const edited = document.createElement('span');
          edited.className = 'edited';
          edited.textContent = '(editado)';
          left.appendChild(edited);
        }
        meta.appendChild(left);

        // Acciones solo si eres el dueÃ±o
        if (m.uid === me) {
          const actions = document.createElement('div');
          actions.className = 'actions';

          const btnEdit = document.createElement('button');
          btnEdit.className = 'btn-icon';
          btnEdit.title = 'Editar';
          btnEdit.textContent = 'âœŽ';
          btnEdit.onclick = async () => {
            const nuevo = prompt('Editar mensaje:', m.text || '');
            if (nuevo === null) return; // cancelado
            const trimmed = nuevo.trim();
            if (!trimmed) { alert('El mensaje no puede quedar vacÃ­o.'); return; }
            try {
              await updateDoc(doc(db, "rooms", "global", "messages", id), {
                text: trimmed,
                editedAt: serverTimestamp()
              });
            } catch (err) {
              console.error('Error al editar:', err);
              alert('No se pudo editar (Â¿reglas?). ' + (err?.message || err));
            }
          };

          const btnDel = document.createElement('button');
          btnDel.className = 'btn-icon';
          btnDel.title = 'Eliminar';
          btnDel.textContent = 'âœ•';
          btnDel.onclick = async () => {
            if (!confirm('Â¿Eliminar este mensaje?')) return;
            try {
              await deleteDoc(doc(db, "rooms", "global", "messages", id));
            } catch (err) {
              console.error('Error al eliminar:', err);
              alert('No se pudo eliminar (Â¿reglas?). ' + (err?.message || err));
            }
          };

          actions.appendChild(btnEdit);
          actions.appendChild(btnDel);
          meta.appendChild(actions);
        }

        div.appendChild(meta);

        const body = document.createElement('div');
        body.textContent = m.text || "";
        div.appendChild(body);

        messagesEl.appendChild(div);
      });
      messagesEl.scrollTop = messagesEl.scrollHeight;
    });

    // Enviar mensaje
    form.onsubmit = async (e) => {
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) return alert("Inicia sesiÃ³n");
      const text = input.value.trim();
      if (!text) return;
      try {
        await addDoc(msgsRef, {
          text,
          uid: user.uid,
          name: user.displayName || user.email,
          createdAt: serverTimestamp()
        });
        input.value = "";
        input.focus();
      } catch (err) {
        console.error('Error al enviar:', err);
        alert('No se pudo enviar (Â¿reglas?). ' + (err?.message || err));
      }
    };
  </script>
</body>
</html>
